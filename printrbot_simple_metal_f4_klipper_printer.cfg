# This is my config for Printrbot Simple Metal with Ubis 13S hotend, stock inductive 
# bed leveling probe, and Extended Heated X-Axis upgrade.
# author = joegibes
#
# These pins are setup for Printrboard Rev F4; please check your printrboard docs.
# For the pins, ! = inverse value and ^ = pullup resistor. For RevF5 and F6 boards you
# can likely use my values, but I haven't tried it!
#
# I recommend deleting the "SAVE_CONFIG" values below,
# as these are generated by calibration procedures like 
# bed_mesh_calibrate, pid_calibrate, etc.

[stepper_x]
step_pin: PA0
dir_pin: !PA1
enable_pin: !PE7
microsteps: 16
rotation_distance: 40
endstop_pin: ^PE3
position_endstop: 0 ; check for your printer
position_max: 252 ; nominal max is 250 but realistically there's some extra
homing_speed: 60

[stepper_y]
step_pin: PA2
dir_pin: !PA3
enable_pin: !PE6
microsteps: 16
rotation_distance: 40
endstop_pin: ^PB4
position_endstop: 150 ; check for your printer
position_max: 152
homing_speed: 60

[stepper_z]
step_pin: PA4
dir_pin: !PA5
enable_pin: !PC7
microsteps: 16
rotation_distance: 1.5841 ; this was WAY off in the default cfg. Calculated from esteps
endstop_pin: probe:z_virtual_endstop ; see Klipper docs for this - we're using
; the inductive probe as Z endstop and for bed leveling, so Klipper
; uses this "virtual endstop" method.
position_min: -2 ; must be less than Zero for bed leveling to work
position_max: 150

[extruder]
step_pin: PA6
dir_pin: PA7
enable_pin: !PC3
microsteps: 16
; ROTATION DISTANCE - calibrate this with the usual extruder Esteps method.
; default is 33.5 but I found this gives me accurate extrusion length.
rotation_distance: 34.00 
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PC5
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF1
#control: pid ; after pid_calibrate, new values are saved in save_config below
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 54
min_temp: 0
max_temp: 260 ; adjust for your hotend - ceramic ubis is lower
;pressure_advance: 0.079 ; this depends on your hardware, temp, and filament.
; see Klipper Docs for how to calibrate Pressure Advance (it's simple!)

[heater_bed]
heater_pin: PC4
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF0
#control: watermark
min_temp: 0
max_temp: 130

[fan]
pin: PC6

[mcu]
serial: /dev/serial/by-id/usb-Klipper_at90usb1286_12345-if00
; see klipper docs for how to obtain this serial

[printer]
kinematics: cartesian
max_velocity: 200
max_accel: 2000
max_z_velocity: 5
max_z_accel: 100

[probe]
pin: ^!PE4
x_offset: 25 ; this is probe location relative to nozzle
y_offset: 0 ; this is probe location relative to nozzle
#z_offset: 1 ; this is adjusted below in "save config" due to virtual endstop
speed: 3
samples: 2
sample_retract_dist: 4
lift_speed: 6
samples_result: average
samples_tolerance: 0.100
samples_tolerance_retries: 0

[bed_mesh] ; this uses 5x3 points for bed leveling. Reference klipper docs
speed: 100
horizontal_move_z: 3
mesh_min: 30,5
mesh_max: 215, 145
probe_count: 5,3
mesh_pps: 2,3
algorithm: bicubic
move_check_distance: 5
split_delta_z: .025
; Fade will slowly adjust the print until it's square to XY, not bed.
fade_start: 1
fade_end: 10
fade_target: -0.2

;[input_shaper] ; disable until you measure resonance (see klipper site)
;shaper_freq_x: 49
;shaper_freq_y: 50
;shaper_type: 2hump_ei



[mcp4728 stepper_current_dac] ; stock printrboard RevF values
scale: 2.327
channel_a: 1.2 # Extruder
channel_b: 1.2 # stepper_z
channel_c: 1.0 # stepper_y
channel_d: 1.0 # stepper_x


##RESONANCE TESTING - see Klipper docs for how to setup with accelerometer and Pi
;[mcu rpi]
;serial: /tmp/klipper_host_mcu

;[adxl345]
;cs_pin: rpi:None

;[resonance_tester]
;accel_chip: adxl345
;probe_points:
; 125,75,20 #an example
##/RESONANCE TESTING

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 52.343
#*# pid_ki = 0.3723
#*# pid_kd = 1839.209
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 38.260
#*# pid_ki = 4.676
#*# pid_kd = 86.085
#*#
#*# [probe]
#*# z_offset = 0.4
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.274000, -0.263109, -0.217319, -0.212368, -0.209646
#*# 	  -0.174003, -0.088858, -0.090096, -0.118560, -0.162865
#*# 	  0.070542, 0.050988, 0.107917, 0.003960, -0.078957
#*# tension = 0.2
#*# min_x = 30.0
#*# algo = bicubic
#*# y_count = 3
#*# mesh_y_pps = 3
#*# min_y = 5.0
#*# x_count = 5
#*# max_y = 145.0
#*# mesh_x_pps = 2
#*# max_x = 215.0
#*#
#*# [bed_mesh DEFAULT]
#*# version = 1
#*# points =
#*# 	  -0.274000, -0.263109, -0.217319, -0.212368, -0.209646
#*# 	  -0.174003, -0.088858, -0.090096, -0.118560, -0.162865
#*# 	  0.070542, 0.050988, 0.107917, 0.003960, -0.078957
#*# tension = 0.2
#*# min_x = 30.0
#*# algo = bicubic
#*# y_count = 3
#*# mesh_y_pps = 3
#*# min_y = 5.0
#*# x_count = 5
#*# max_y = 145.0
#*# mesh_x_pps = 2
#*# max_x = 215.0
